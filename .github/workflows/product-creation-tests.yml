name: E2E Tests

on:
  # make this workflow reusable and take in marketplace version as input
  workflow_call:
    inputs:
        use-marketplace-version:
          description: 'Should this use marketplace version of the plugin'
          required: false
          type: boolean
          default: false
  workflow_dispatch:
    inputs:
        use-marketplace-version:
          description: 'Should this use marketplace version of the plugin'
          required: false
          type: boolean
          default: false
  pull_request:
    branches: [ main, master, develop ]

env:
  # Test environment configuration
  TEST_SITE_HOST: ${{ secrets.TEST_SITE_HOST }}
  WORDPRESS_PATH: '/tmp/wordpress'
  WP_DEBUG_LOG: '/tmp/wordpress/wp-content/debug.log'
  PLUGIN_PATH: '/tmp/wordpress/wp-content/plugins/facebook-for-woocommerce'
  FB_E2E_TEST_COOKIE_NAME: 'facebook_test_id'
  FB_E2E_LOGGER_PATH: '/tests/e2e/lib/Logger.php'
  FB_E2E_CAPTURED_EVENTS_DIR: '/tests/e2e/captured-events'
  WP_CUSTOMER_USERNAME: customer
  WP_CUSTOMER_PASSWORD: Password@54321
  WORDPRESS_URL: http://${{ secrets.TEST_SITE_HOST }}:8080
  TEST_PRODUCT_URL: '/product/testp/'
  TEST_CATEGORY_URL: '/product-category/uncategorized/'
  TEST_FBCLID: 'IwAR123TestClickId456'
  WP_ADMIN_USERNAME: admin
  WP_ADMIN_PASSWORD: admin
  PIXEL_EVENT_TIMEOUT: 30000
  PAGE_LOAD_TIMEOUT: 120000


jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: wordpress
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wordpress
          MYSQL_PASSWORD: wordpress
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, zip, gd, curl, dom, imagick, fileinfo, mbstring

      - name: Configure hostname
        run: |
          # Add hosts entry for custom domain
          echo "127.0.0.1 ${{ env.TEST_SITE_HOST }}" | sudo tee -a /etc/hosts
          echo "âœ… Added hosts entry for ${{ env.TEST_SITE_HOST }}"

      - name: Create WordPress test environment
        run: |
          # Create WordPress directory
          mkdir -p ${{ env.WORDPRESS_PATH }}
          cd ${{ env.WORDPRESS_PATH }}

          # Download WordPress
          curl -O https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz --strip-components=1

          # Create wp-config.php
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/wordpress/" wp-config.php
          sed -i "s/password_here/wordpress/" wp-config.php
          sed -i "s/localhost/127.0.0.1/" wp-config.php

          # Add debug and security settings
          cat >> wp-config.php << 'EOF'

          // Debug settings
          define('WP_DEBUG', true);
          define('WP_DEBUG_LOG', true);
          define('WP_DEBUG_DISPLAY', false);
          @ini_set('error_log', '${{ env.WP_DEBUG_LOG }}');
          @ini_set('log_errors', 'On');

          // Security keys (for testing only)
          define('AUTH_KEY',         'testing-key-1');
          define('SECURE_AUTH_KEY',  'testing-key-2');
          define('LOGGED_IN_KEY',    'testing-key-3');
          define('NONCE_KEY',        'testing-key-4');
          define('AUTH_SALT',        'testing-salt-1');
          define('SECURE_AUTH_SALT', 'testing-salt-2');
          define('LOGGED_IN_SALT',   'testing-salt-3');
          define('NONCE_SALT',       'testing-salt-4');

          EOF

      - name: Wordpress debug log file setup
        run: |
          # Create debug.log file and make it writable
          touch ${{ env.WP_DEBUG_LOG }}
          chmod 777 ${{ env.WP_DEBUG_LOG }}
          echo "âœ… debug.log created and writable"


      - name: Start PHP server
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          php -S 127.0.0.1:8080 -t . &
          echo $! > /tmp/php-server.pid
          sleep 5
          echo "âœ… PHP server started on port 8080"

      - name: Create Facebook Catalog
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi

          CATALOG_NAME="Test-Catalog-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "Using catalog name: $CATALOG_NAME"

          echo "Creating Facebook product catalog..."
          RESPONSE=$(curl -s -X POST \
            "https://graph.facebook.com/v24.0/${{ secrets.FB_BUSINESS_MANAGER_ID }}/owned_product_catalogs" \
            -d "name=$CATALOG_NAME" \
            -d "vertical=commerce" \
            -d "access_token=${{ secrets.FB_ACCESS_TOKEN_NEW }}" )

          echo "Response: $RESPONSE"

          CATALOG_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ -z "$CATALOG_ID" ] || [ "$CATALOG_ID" = "null" ]; then
            echo "âŒ Failed to create catalog or extract catalog ID"
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "âœ… Created catalog with ID: $CATALOG_ID"
          echo "FB_PRODUCT_CATALOG_ID=$CATALOG_ID" >> $GITHUB_ENV

      - name: Add Test Product to Catalog (Required for Product Sets)
        run: |
          echo "================================================================"
          echo "ðŸ” TESTING: Can we create product sets on newly created catalog?"
          echo "================================================================"
          echo ""
          echo "Step 1: Adding a test product to the catalog..."
          echo "Why? Meta API requires at least one product before creating product sets"

          # Upload product to catalog using form-encoded parameters (not JSON)
          echo "Uploading test product to catalog ${{ env.FB_PRODUCT_CATALOG_ID }}..."
          PRODUCT_RESPONSE=$(curl -s -X POST \
            "https://graph.facebook.com/v24.0/${{ env.FB_PRODUCT_CATALOG_ID }}/products" \
            -d "retailer_id=test-product-001" \
            -d "name=Test Product" \
            -d "description=Test product for product set validation" \
            -d "availability=in stock" \
            -d "condition=new" \
            -d "price=1999" \
            -d "currency=USD" \
            -d "link=https://test.example.com/product/test" \
            -d "image_link=https://via.placeholder.com/600x600" \
            -d "image_url=https://via.placeholder.com/600x600" \
            -d "brand=Test Brand" \
            -d "access_token=${{ secrets.FB_ACCESS_TOKEN_NEW }}")

          echo "Product creation response: $PRODUCT_RESPONSE"

          PRODUCT_ID=$(echo "$PRODUCT_RESPONSE" | jq -r '.id // empty')
          if [ -n "$PRODUCT_ID" ]; then
            echo "âœ… Successfully added test product with ID: $PRODUCT_ID"
            echo "TEST_CATALOG_PRODUCT_ID=$PRODUCT_ID" >> $GITHUB_ENV
          else
            echo "âš ï¸ Could not add product to catalog"
            echo "Full Response: $PRODUCT_RESPONSE"
          fi
          echo ""

      - name: Test Product Set Creation on Empty vs Non-Empty Catalog
        run: |
          echo "Step 2: Now attempting to create product set..."
          echo ""

          # Product set data matching the plugin's structure
          PRODUCT_SET_NAME="Test-Category"
          RETAILER_ID="test-retailer-id-123"

          # Build the filter JSON (matches WooCommerce plugin logic)
          FILTER_JSON='{"and": [{"product_type": {"i_contains": "Test-Category"}}]}'
          METADATA_JSON='{"description": "Test product set for E2E testing", "external_url": "https://test.example.com/category/test"}'

          echo "Creating product set with:"
          echo "  Catalog ID: ${{ env.FB_PRODUCT_CATALOG_ID }}"
          echo "  Name: $PRODUCT_SET_NAME"
          echo "  Retailer ID: $RETAILER_ID"
          echo "  Filter: $FILTER_JSON"

          # Create product set via Facebook Graph API
          RESPONSE=$(curl -s -X POST \
            "https://graph.facebook.com/v24.0/${{ env.FB_PRODUCT_CATALOG_ID }}/product_sets" \
            -H "Content-Type: application/json" \
            -d "name=$PRODUCT_SET_NAME" \
            -d "retailer_id=$RETAILER_ID" \
            --data-urlencode "filter=$FILTER_JSON" \
            --data-urlencode "metadata=$METADATA_JSON" \
            -d "access_token=${{ secrets.FB_ACCESS_TOKEN_NEW }}")

          echo "Response: $RESPONSE"

          # Check if product set was created successfully
          PRODUCT_SET_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          ERROR_MESSAGE=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          ERROR_CODE=$(echo "$RESPONSE" | jq -r '.error.code // empty')
          ERROR_SUBCODE=$(echo "$RESPONSE" | jq -r '.error.error_subcode // empty')
          ERROR_USER_TITLE=$(echo "$RESPONSE" | jq -r '.error.error_user_title // empty')
          ERROR_USER_MSG=$(echo "$RESPONSE" | jq -r '.error.error_user_msg // empty')

          echo ""
          echo "================================================================"
          if [ -n "$PRODUCT_SET_ID" ]; then
            echo "âœ… SUCCESS: Product set created with ID: $PRODUCT_SET_ID"
            echo "================================================================"
            echo ""
            echo "ðŸ“ FINDING: Product sets CAN be created after adding products to catalog"
            echo "TEST_PRODUCT_SET_ID=$PRODUCT_SET_ID" >> $GITHUB_ENV
          else
            echo "âŒ FAILED: Could not create product set"
            echo "================================================================"
            echo ""
            if [ "$ERROR_SUBCODE" = "1798130" ]; then
              echo "ðŸ”´ ROOT CAUSE IDENTIFIED:"
              echo "   Error: $ERROR_USER_TITLE"
              echo "   Message: $ERROR_USER_MSG"
              echo ""
              echo "ðŸ“ FINDING: Meta API requires catalogs to have products before"
              echo "            creating product sets (error_subcode: 1798130)"
              echo ""
              echo "ðŸ› BUG IN WOOCOMMERCE PLUGIN:"
              echo "   The plugin tries to sync categories (as product sets) before"
              echo "   ensuring products exist in the catalog, causing silent failures."
              echo ""
              echo "ðŸ’¡ SOLUTION NEEDED:"
              echo "   1. Sync products BEFORE syncing categories/product sets"
              echo "   2. Handle error 1798130 gracefully and retry after product sync"
              echo "   3. Show user-facing error instead of silent logging"
            else
              echo "Error Details:"
              echo "  Code: $ERROR_CODE"
              echo "  Subcode: $ERROR_SUBCODE"
              echo "  Message: $ERROR_MESSAGE"
              echo "  User Title: $ERROR_USER_TITLE"
              echo "  User Message: $ERROR_USER_MSG"
            fi
            echo ""
            echo "Full Response: $RESPONSE"
          fi
          echo "================================================================"
          echo ""
          # Don't fail the workflow - we want to see the result either way
          exit 0

      - name: Install WP-CLI
        run: |
          echo "=== Installing WP-CLI ==="
          curl -L -o wp-cli.phar https://github.com/wp-cli/wp-cli/releases/download/v2.10.0/wp-cli-2.10.0.phar

          if head -1 wp-cli.phar | grep -q "#!/usr/bin/env php"; then
            chmod +x wp-cli.phar
            sudo mv wp-cli.phar /usr/local/bin/wp
            echo "âœ… WP-CLI installed successfully"
          else
            echo "âŒ Downloaded file is not valid PHP"
            exit 1
          fi

          wp --version

      - name: Install WordPress
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          wp core install \
            --url=http://${{ env.TEST_SITE_HOST }}:8080 \
            --title="E2E Test Site" \
            --admin_user=admin \
            --admin_password=admin \
            --admin_email=test@example.com \
            --allow-root

      - name: Install WooCommerce
        run: |
          cd ${{ env.WORDPRESS_PATH }}

          # Install Storefront theme (official WooCommerce theme with all hooks)
          wp theme install storefront --activate --allow-root
          echo "âœ… Storefront theme installed and activated"
          wp plugin install woocommerce --activate --allow-root

          # Basic WooCommerce setup
          wp option update woocommerce_store_address "123 Test Street" --allow-root
          wp option update woocommerce_store_city "Test City" --allow-root
          wp option update woocommerce_default_country "US:CA" --allow-root
          wp option update woocommerce_store_postcode "12345" --allow-root
          wp option update woocommerce_currency "USD" --allow-root

          # Make site live (disable "Coming Soon" mode)
          wp option update woocommerce_coming_soon "no" --allow-root
          wp option update woocommerce_store_pages_only "no" --allow-root
          echo "âœ… WooCommerce site set to LIVE mode"

      # - name: Create wp non admin user
      #   run: |
      #     cd ${{ env.WORDPRESS_PATH }}
      #     # Create a customer (non-admin) user for testing
      #     # Pixel tracking excludes admin users by default!
      #     # Note: customer role is created by WooCommerce, so this step must run AFTER WooCommerce installation
      #     wp user create ${{ env.WP_CUSTOMER_USERNAME}} customer@test.com --role=customer --user_pass=${{ env.WP_CUSTOMER_PASSWORD }} --allow-root || echo "Customer user already exists"

      #     # Grant read capability to customer role (for viewing products/categories)
      #     # This ensures customer can see shop pages, products, and categories
      #     wp cap add customer read --allow-root

      #     echo "âœ… Customer user created with proper capabilities"
      - name: Install WPC Composite Products plugin
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          wp plugin install wpc-composite-products --activate --allow-root

      - name: Install Facebook for WooCommerce plugin
        run: |
          cd ${{ env.WORDPRESS_PATH }}

          # Use marketplace version if flag is true
          if [ "${{ inputs.use-marketplace-version }}" = "true" ]; then
            echo "Installing Facebook for WooCommerce from wordpress.org marketplace"
            wp plugin install facebook-for-woocommerce --version=dev --allow-root
          else
            echo "Installing Facebook for WooCommerce from local workspace"
            # Copy plugin files from the checked out repository root
            cp -r ${{ github.workspace }} wp-content/plugins/facebook-for-woocommerce/

            # Install Composer dependencies for the plugin
            cd ${{ env.PLUGIN_PATH }}
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader
            fi
            cd ${{ env.WORDPRESS_PATH }}
          fi

          # Force enable WooCommerce logging BEFORE plugin activation
          echo "ðŸ”§ Force-enabling WooCommerce logging..."
          wp option update woocommerce_logging_enabled "yes" --allow-root
          wp option update woocommerce_log_handler "WC_Log_Handler_File" --allow-root
          wp option update woocommerce_log_threshold "debug" --allow-root
          echo "âœ… WooCommerce logging forced to enabled with debug level"

          # Configure Facebook connection before activation
          wp option update wc_facebook_access_token "${{ secrets.FB_ACCESS_TOKEN_NEW }}" --allow-root
          wp option update wc_facebook_merchant_access_token "${{ secrets.FB_ACCESS_TOKEN_NEW }}" --allow-root
          wp option update wc_facebook_business_manager_id "${{ secrets.FB_BUSINESS_MANAGER_ID }}" --allow-root
          wp option update wc_facebook_external_business_id "${{ secrets.FB_EXTERNAL_BUSINESS_ID }}" --allow-root
          wp option update wc_facebook_product_catalog_id "${{ env.FB_PRODUCT_CATALOG_ID }}" --allow-root
          wp option update wc_facebook_pixel_id "${{ secrets.FB_PIXEL_ID }}" --allow-root
          wp option update wc_facebook_enable_server_to_server "yes" --allow-root
          wp option update wc_facebook_enable_pixel "yes" --allow-root
          wp option update wc_facebook_enable_advanced_matching "yes" --allow-root
          wp option update wc_facebook_debug_mode yes --allow-root
          wp option update wc_facebook_has_connected_fbe_2 "yes" --allow-root
          wp option update wc_facebook_has_authorized_pages_read_engagement "yes" --allow-root
          wp option update wc_facebook_enable_product_sync "yes" --allow-root
          wp option update wc_facebook_page_id  "${{ secrets.FB_PAGE_ID }}" --allow-root

          # DO NOT set the sync flag - we want to force a sync
          # wp option update _transient__wc_facebook_for_woocommerce_product_sets_sync_flag  yes --allow-root

          # Activate the plugin (this triggers automatic sync)
          wp plugin activate facebook-for-woocommerce --allow-root

      - name: Force category sync and capture logs
        run: |
          cd ${{ env.WORDPRESS_PATH }}

          echo "================================================================"
          echo "ðŸ”§ Manually triggering category sync to generate logs..."
          echo "================================================================"
          echo ""

          # Check WooCommerce logging status
          echo "ðŸ“‹ WooCommerce logging configuration:"
          wp option get woocommerce_logging_enabled --allow-root
          wp option get woocommerce_log_handler --allow-root
          wp option get woocommerce_log_threshold --allow-root
          echo ""

          # Delete the sync flag to allow immediate sync
          echo "ðŸ—‘ï¸ Deleting sync throttle flag..."
          wp transient delete _wc_facebook_for_woocommerce_product_sets_sync_flag --allow-root
          echo "âœ… Sync throttle removed"
          echo ""

          # Manually trigger category sync
          echo "â–¶ï¸ Triggering category sync..."
          wp eval "
            if (function_exists('facebook_for_woocommerce')) {
                echo 'âœ… Facebook plugin loaded' . PHP_EOL;

                // Get the product sets sync handler
                \$sync_handler = facebook_for_woocommerce()->get_product_sets_sync_handler();
                if (\$sync_handler) {
                    echo 'âœ… Product sets sync handler available' . PHP_EOL;

                    try {
                        // Force sync all categories
                        \$sync_handler->sync_all_product_sets();
                        echo 'âœ… sync_all_product_sets() completed' . PHP_EOL;
                    } catch (Exception \$e) {
                        echo 'âŒ Exception during sync: ' . \$e->getMessage() . PHP_EOL;
                        echo 'Trace: ' . \$e->getTraceAsString() . PHP_EOL;
                    }
                } else {
                    echo 'âŒ Product sets sync handler NOT available' . PHP_EOL;
                }
            } else {
                echo 'âŒ Facebook plugin NOT loaded' . PHP_EOL;
            }" --allow-root
          echo ""

          echo "ðŸ“‚ Checking for newly created log files..."
          # Check if WooCommerce created log directories
          if [ -d "${{ env.WORDPRESS_PATH }}/wp-content/wc-logs" ]; then
            echo "âœ… wc-logs directory exists now!"
            ls -lah ${{ env.WORDPRESS_PATH }}/wp-content/wc-logs/
          elif [ -d "${{ env.WORDPRESS_PATH }}/wp-content/uploads/wc-logs" ]; then
            echo "âœ… uploads/wc-logs directory exists now!"
            ls -lah ${{ env.WORDPRESS_PATH }}/wp-content/uploads/wc-logs/
          else
            echo "âŒ Still no WooCommerce log directories created"
            echo "This indicates logging is not working or no logs were generated"
          fi
          echo ""

          echo "================================================================"

      # - name: Initialize rollout switches for E2E tests
      #   run: |
      #       cd ${{ env.WORDPRESS_PATH }}
      #       # Force initialize rollout switches - this would normally happen on heartbeat
      #       wp eval "
      #         if (function_exists('facebook_for_woocommerce')) {
      #             \$plugin = facebook_for_woocommerce();
      #             \$rollout_switches = \$plugin->get_rollout_switches();
      #             \$rollout_switches->init();
      #             echo 'âœ… Rollout switches initialized' . PHP_EOL;
      #         }" --allow-root

      #       # Manually enable CAPI event logging for E2E tests
      #       # This is required for test event capture to work
      #       wp eval "
      #         \$switches = get_option('wc_facebook_for_woocommerce_rollout_switches', []);
      #         \$switches['enable_woocommerce_capi_event_logging'] = 'yes';
      #         update_option('wc_facebook_for_woocommerce_rollout_switches', \$switches);
      #         echo 'âœ… CAPI event logging enabled for E2E tests' . PHP_EOL;
      #         " --allow-root

      - name: Verify WordPress setup
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          echo "=== WordPress Info ==="
          wp core version --allow-root
          echo "=== Active Plugins ==="
          wp plugin list --status=active --allow-root
          echo "=== Site URL ==="
          wp option get siteurl --allow-root

          # Test if site is accessible
          curl -f http://${{ env.TEST_SITE_HOST }}:8080 || exit 1

      - name: Verify Facebook for WooCommerce setup
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          echo "=== Facebook for WooCommerce Info ==="
          wp eval "
            if (function_exists('facebook_for_woocommerce')) {
                \$connection = facebook_for_woocommerce()->get_connection_handler();
                if (!\$connection->is_connected()) {
                    echo 'âŒ Facebook plugin is NOT connected' . PHP_EOL;
                    exit(1);
                }
                echo 'Connected: YES' . PHP_EOL;
                echo 'Access Token: ' . (\$connection->get_access_token() ? 'Present' : 'Missing') . PHP_EOL;
                echo 'External Business ID: ' . \$connection->get_external_business_id() . PHP_EOL;
                echo 'Business Manager ID: ' . \$connection->get_business_manager_id() . PHP_EOL;
                echo 'Pixel ID: ' . get_option('wc_facebook_pixel_id') . PHP_EOL;
                echo 'Pixel Enabled: ' . get_option('wc_facebook_enable_pixel') . PHP_EOL;
                echo 'S2S Enabled: ' . get_option('wc_facebook_enable_server_to_server') . PHP_EOL;
                echo 'Debug Mode: ' . get_option('wc_facebook_debug_mode') . PHP_EOL;
            } else {
                echo 'âŒ Facebook plugin not loaded properly' . PHP_EOL;
                exit(1);
            }" --allow-root

          # VERIFY wp-config.php has debug settings
          echo "=== Verifying wp-config.php Debug Settings ==="
          if grep -q "WP_DEBUG.*true" wp-config.php; then
            echo "âœ… WP_DEBUG is enabled"
          else
            echo "âŒ WP_DEBUG is NOT enabled!"
            exit 1
          fi

      - name: Install Playwright
        run: |
          # Install in the WordPress plugin directory (where we'll run tests from)
          cd ${{ env.PLUGIN_PATH }}
          npm install
          npx playwright install chromium
          npx playwright install-deps chromium

      # - name: Setup captured-events directory
      #   run: |
      #     mkdir -p ${{ env.PLUGIN_PATH }}/tests/e2e/captured-events
      #     chmod 777 ${{ env.PLUGIN_PATH }}/tests/e2e/captured-events

      # - name: Create test product for CAPI Pixel E2E tests
      #   env:
      #     WP_USERNAME: admin
      #     WP_PASSWORD: admin
      #   run: |
      #     cd ${{ env.WORDPRESS_PATH }}
      #     # Create test product for ViewContent/AddToCart tests
      #     PRODUCT_ID=$(wp eval "
      #       \$product = new WC_Product_Simple();
      #       \$product->set_name('TestP');
      #       \$product->set_slug('testp');
      #       \$product->set_regular_price('19.99');
      #       \$product->set_description('Test product for E2E tests');
      #       \$product->set_status('publish');
      #       \$product->set_catalog_visibility('visible');
      #       \$product->set_stock_status('instock');
      #       \$product->set_manage_stock(false);
      #       \$product_id = \$product->save();
      #       wp_set_object_terms(\$product_id, 'uncategorized', 'product_cat');
      #       echo \$product_id;
      #     " --allow-root)

      #     echo "TEST_PRODUCT_ID=$PRODUCT_ID" >> $GITHUB_ENV
      #     echo "âœ… Test product created. ID: $PRODUCT_ID"

      # - name: Install Xvfb for headed browser
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y xvfb

      # - name: Run CAPI Pixel E2E tests
      #   env:
      #     TEST_PRODUCT_ID: ${{ env.TEST_PRODUCT_ID }}
      #   run: |
      #     cd ${{ env.PLUGIN_PATH }}
      #     xvfb-run --auto-servernum npx playwright test events-test*.spec.js --headed

      # - name: Cleanup test product
      #   if: always()
      #   run: |
      #     cd ${{ env.WORDPRESS_PATH }}
      #     if [ -n "${{ env.TEST_PRODUCT_ID }}" ]; then
      #       wp post delete ${{ env.TEST_PRODUCT_ID }} --force --allow-root
      #       echo "âœ… Test product ${{ env.TEST_PRODUCT_ID }} deleted"
      #     else
      #       echo "â„¹ï¸ No test product to delete"
      #     fi

      - name: Run E2E tests
        env:
          WP_USERNAME: admin
          WP_PASSWORD: admin
        run: |
          cd ${{ env.PLUGIN_PATH }}
          npx playwright test product-category.spec.js

      - name: Disconnect from catalog
        if: always()
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          wp eval "
            if (function_exists('facebook_for_woocommerce')) {
                \$connection = facebook_for_woocommerce()->get_connection_handler();
                if (\$connection->is_connected()) {
                    \$connection->disconnect();
                    echo 'âœ… Disconnected from catalog' . PHP_EOL;
                } else {
                    echo 'â„¹ï¸ Already disconnected' . PHP_EOL;
                }
            }" --allow-root

      - name: Verify disconnection
        if: always()
        run: |
          cd ${{ env.WORDPRESS_PATH }}
          wp eval "
            if (function_exists('facebook_for_woocommerce')) {
                \$connection = facebook_for_woocommerce()->get_connection_handler();
                if (\$connection->is_connected()) {
                    echo 'âŒ Still connected' . PHP_EOL;
                    exit(1);
                }
                echo 'âœ… Verified disconnected' . PHP_EOL;
            }" --allow-root

      - name: Check for PHP errors, and dump debug log
        if: always()
        run: |
          if [ -f ${{ env.WP_DEBUG_LOG }} ]; then
            # Capture PHP errors in a variable (excluding WordPress cron warnings)
            PHP_ERRORS=$(grep -i "fatal\|error" ${{ env.WP_DEBUG_LOG }} | grep -v "Cron reschedule event error for hook: facebook_for_woocommerce_5_minute_heartbeat_cron" || true)
            if [ -n "$PHP_ERRORS" ]; then
              echo "âŒ PHP errors detected:"
              echo "$PHP_ERRORS"
              exit 1
            else
              echo "âœ… No critical PHP errors found"
            fi
          else
            echo "âœ… No debug log found - no PHP errors"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ${{ env.PLUGIN_PATH }}/playwright-report/
          retention-days: 7

      - name: Upload captured events
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: CAPI Pixel Captured events
          path: ${{ env.PLUGIN_PATH }}${{ env.FB_E2E_CAPTURED_EVENTS_DIR }}
          retention-days: 7

      - name: Cleanup captured events directory
        if: always()
        run: |
          TARGET_DIR="${{ env.PLUGIN_PATH }}${{ env.FB_E2E_CAPTURED_EVENTS_DIR }}"
          if [ -d "$TARGET_DIR" ]; then
            rm -rf "$TARGET_DIR"
            echo "âœ… Deleted captured events directory: $TARGET_DIR"
          else
            echo "â„¹ï¸ Captured events directory not found: $TARGET_DIR"
          fi

      - name: Upload PHP logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: php-debug-logs
          path: ${{ env.WP_DEBUG_LOG }}
          retention-days: 7

      - name: Investigate WooCommerce log locations
        if: always()
        run: |
          echo "================================================================"
          echo "ðŸ” Investigating WooCommerce log file locations..."
          echo "================================================================"
          echo ""

          echo "ðŸ“‚ WordPress path: ${{ env.WORDPRESS_PATH }}"
          echo ""

          echo "1ï¸âƒ£ Listing wp-content directory structure:"
          ls -la ${{ env.WORDPRESS_PATH }}/wp-content/ || echo "âš ï¸ wp-content directory not found"
          echo ""

          echo "2ï¸âƒ£ Checking for wc-logs directory:"
          if [ -d "${{ env.WORDPRESS_PATH }}/wp-content/wc-logs" ]; then
            echo "âœ… Found: wp-content/wc-logs/"
            echo "Contents:"
            ls -lah ${{ env.WORDPRESS_PATH }}/wp-content/wc-logs/
          else
            echo "âŒ Not found: wp-content/wc-logs/"
          fi
          echo ""

          echo "3ï¸âƒ£ Checking for uploads/wc-logs directory:"
          if [ -d "${{ env.WORDPRESS_PATH }}/wp-content/uploads/wc-logs" ]; then
            echo "âœ… Found: wp-content/uploads/wc-logs/"
            echo "Contents:"
            ls -lah ${{ env.WORDPRESS_PATH }}/wp-content/uploads/wc-logs/
          else
            echo "âŒ Not found: wp-content/uploads/wc-logs/"
          fi
          echo ""

          echo "4ï¸âƒ£ Searching for any log files in wp-content:"
          find ${{ env.WORDPRESS_PATH }}/wp-content/ -name "*.log" -type f 2>/dev/null | while read logfile; do
            echo "ðŸ“„ Found log file: $logfile"
            echo "   Size: $(du -h "$logfile" | cut -f1)"
            echo "   Modified: $(stat -c '%y' "$logfile" 2>/dev/null || stat -f '%Sm' "$logfile")"
          done || echo "No .log files found"
          echo ""

          echo "5ï¸âƒ£ Checking debug.log specifically:"
          if [ -f "${{ env.WP_DEBUG_LOG }}" ]; then
            echo "âœ… Found debug.log at: ${{ env.WP_DEBUG_LOG }}"
            echo "   Size: $(du -h ${{ env.WP_DEBUG_LOG }} | cut -f1)"
            echo "   Last 10 lines:"
            tail -n 10 ${{ env.WP_DEBUG_LOG }}
          else
            echo "âŒ debug.log not found at: ${{ env.WP_DEBUG_LOG }}"
          fi
          echo ""

          echo "6ï¸âƒ£ Checking WooCommerce log status option:"
          cd ${{ env.WORDPRESS_PATH }}
          LOG_STATUS=$(wp option get w --allow-root 2>/dev/null || echo "option not set")
          echo "WooCommerce logs location setting: $LOG_STATUS"
          echo ""

          echo "7ï¸âƒ£ Looking for facebook-for-woocommerce specific logs:"
          find ${{ env.WORDPRESS_PATH }}/wp-content/ -name "*facebook*" -name "*.log" -type f 2>/dev/null | while read fblog; do
            echo "ðŸ“„ Found Facebook log: $fblog"
            echo "   Size: $(du -h "$fblog" | cut -f1)"
          done || echo "No Facebook-specific log files found"
          echo ""

          echo "8ï¸âƒ£ Checking WooCommerce logging settings:"
          cd ${{ env.WORDPRESS_PATH }}
          WC_LOGGING=$(wp option get woocommerce_logging_enabled --allow-root 2>/dev/null || echo "not set")
          echo "WooCommerce logging enabled: $WC_LOGGING"
          WC_LOG_HANDLER=$(wp option get woocommerce_log_handler --allow-root 2>/dev/null || echo "not set")
          echo "WooCommerce log handler: $WC_LOG_HANDLER"
          WC_LOG_DIRECTORY=$(wp option get woocommerce_log_directory --allow-root 2>/dev/null || echo "not set")
          echo "WooCommerce log directory: $WC_LOG_DIRECTORY"
          echo ""

          echo "9ï¸âƒ£ Extracting Facebook-related errors from debug.log:"
          if [ -f "${{ env.WP_DEBUG_LOG }}" ]; then
            echo "Searching for ProductSetSync, facebook, and catalog-related errors..."
            grep -i "productset\|facebook.*error\|facebook.*exception\|catalog.*error" ${{ env.WP_DEBUG_LOG }} | head -n 50 || echo "No Facebook-related errors found in debug.log"
          else
            echo "debug.log not found"
          fi
          echo ""

          echo "================================================================"
          echo "Investigation complete"
          echo "================================================================"

      - name: Create Facebook-specific log extract
        if: always()
        run: |
          echo "Creating Facebook-specific log extract from debug.log..."
          if [ -f "${{ env.WP_DEBUG_LOG }}" ]; then
            # Extract all Facebook plugin related logs
            grep -i "facebook\|productset\|product_set\|catalog" ${{ env.WP_DEBUG_LOG }} > /tmp/facebook-logs-extract.log 2>/dev/null || echo "No Facebook logs to extract"

            if [ -s /tmp/facebook-logs-extract.log ]; then
              echo "âœ… Created Facebook log extract with $(wc -l < /tmp/facebook-logs-extract.log) lines"
              echo ""
              echo "ðŸ“‹ Preview of Facebook log extract (first 20 lines):"
              head -n 20 /tmp/facebook-logs-extract.log
              echo ""
              echo "ðŸ“‹ Preview of Facebook log extract (last 20 lines):"
              tail -n 20 /tmp/facebook-logs-extract.log
            else
              echo "âš ï¸ No Facebook-related content found in debug.log"
              echo "This might mean:"
              echo "  - Facebook plugin hasn't logged anything yet"
              echo "  - Logging is disabled"
              echo "  - No errors occurred"
            fi
          else
            echo "âŒ debug.log not found at ${{ env.WP_DEBUG_LOG }}"
          fi

      - name: Upload WooCommerce logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: woocommerce-logs
          path: |
            ${{ env.WORDPRESS_PATH }}/wp-content/wc-logs/
            ${{ env.WORDPRESS_PATH }}/wp-content/uploads/wc-logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Facebook log extract
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: facebook-logs-extract
          path: /tmp/facebook-logs-extract.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test videos/screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-failures
          path: ${{ env.PLUGIN_PATH }}/test-results/
          retention-days: 7

      - name: Cleanup - Delete Facebook Catalog
        if: always()
        run: |
          if [ -z "${{ env.FB_PRODUCT_CATALOG_ID }}" ]; then
            echo "âš ï¸ No catalog ID found, skipping cleanup"
            exit 0
          fi

          echo "Deleting test catalog ID: ${{ env.FB_PRODUCT_CATALOG_ID }}..."
          RESPONSE=$(curl -s -X DELETE \
            "https://graph.facebook.com/v24.0/${{ env.FB_PRODUCT_CATALOG_ID }}?access_token=${{ secrets.FB_ACCESS_TOKEN_NEW }}")

          echo "Response: $RESPONSE"

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully deleted test catalog"
          else
            echo "âš ï¸ Failed to delete catalog or unexpected response"
            echo "Response: $RESPONSE"
            # Don't fail the workflow on cleanup errors
            exit 0
          fi
